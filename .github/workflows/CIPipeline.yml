name: Pipeline CI/CD

on:
  push:
    branches:
      - main
      - DEV
  pull_request:
    branches:
      - main

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Revisión de Estilo de Código
    steps:
      - name: Obtener código fuente
        uses: actions/checkout@v2

      - name: Configurar Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Instalar dependencias
        run: npm install

      - name: Revisar archivos JavaScript
        run: npm run lint:js

  test:
    runs-on: ubuntu-latest
    name: Ejecución de Pruebas
    needs: lint
    steps:
      - name: Obtener código fuente
        uses: actions/checkout@v2

      - name: Configurar Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Instalar dependencias
        run: npm install

      - name: Ejecutar pruebas
        run: npm test
        continue-on-error: true

      - name: Guardar resultados de pruebas
        if: failure()
        run: |
          echo "Resultados de pruebas:"
          cat ./test-results.xml
        continue-on-error: true

  notify_dev_success:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/DEV' && needs.test.result == 'success'
    steps:
      - name: Enviar notificación de éxito a Slack para DEV
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Las pruebas en la rama DEV pasaron exitosamente.\nMensaje del Commit: ${{ github.event.head_commit.message }}\nAutor: ${{ github.actor }}\nRama: ${{ github.ref }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify_dev_failure:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/DEV' && needs.test.result == 'failure'
    steps:
      - name: Enviar notificación de fallo a Slack para DEV
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Las pruebas en la rama DEV fallaron.\nMensaje del Commit: ${{ github.event.head_commit.message }}\nAutor: ${{ github.actor }}\nRama: ${{ github.ref }}\nResultados de pruebas:\n$(cat ./test-results.xml)"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  create_pull_request:
    runs-on: ubuntu-latest
    needs: notify_dev_success
    if: github.ref == 'refs/heads/DEV' && needs.test.result == 'success'
    steps:
      - name: Obtener código fuente
        uses: actions/checkout@v2

      - name: Crear Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.PAT }}
          commit-message: "Auto PR from DEV to main"
          committer: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          title: "Auto PR from DEV to main"
          body: "Este es un pull request automático de la rama DEV a la rama main"
          base: main
          branch: DEV

  deploy:
    runs-on: ubuntu-latest
    name: Despliegue en GitHub Pages
    needs: [create_pull_request]
    steps:
      - name: Obtener código fuente
        uses: actions/checkout@v2

      - name: Crear directorio de despliegue
        run: mkdir -p gh-pages

      - name: Copiar archivos de docs a gh-pages
        run: cp -r docs/* gh-pages/

      - name: Desplegar en GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.PAT }}
          publish_dir: ./gh-pages

  notify_deploy_success:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    steps:
      - name: Enviar notificación de éxito de deploy a Slack
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "El despliegue en la rama ${{ github.ref }} fue exitoso.\nMensaje del Commit: ${{ github.event.head_commit.message }}\nAutor: ${{ github.actor }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify_deploy_failure:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Enviar notificación de fallo de deploy a Slack
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "El despliegue en la rama ${{ github.ref }} falló.\nMensaje del Commit: ${{ github.event.head_commit.message }}\nAutor: ${{ github.actor }}\nError: $(cat ./deploy-error-log.txt)"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
